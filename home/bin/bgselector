#!/usr/bin/env bash

wall_dir="$HOME/confix/assets/wallpapers"
cache_dir="$HOME/.cache/thumbnails/bgselector"

mkdir -p "$wall_dir"
mkdir -p "$cache_dir"

# Generate thumbnails
find "$wall_dir" -type f \( -iname '*.jpg' -o -iname '*.jpeg' -o -iname '*.png' -o -iname '*.webp' -o -iname '*.gif' \) | while read -r imagen; do
	filename="$(basename "$imagen")"
	thumb="$cache_dir/$filename"
	if [ ! -f "$thumb" ]; then
		ffmpeg -y -i "$imagen" -vf "thumbnail,scale=-1:540:force_original_aspect_ratio=increase,crop=262:540" -frames:v 1 "$thumb"
	fi
done

# List wallpapers with icons for rofi
wall_selection=$(ls "$wall_dir" | while read -r A; do echo -en "$A\x00icon\x1f$cache_dir/$A\n"; done | rofi -dmenu -config "$HOME/.config/rofi/bgselector.rasi")

# Set wallpaper and update waybar color
if [ -n "$wall_selection" ]; then
	wal -i $wall_dir/$wall_selection
    matugen image $wall_dir/$wall_selection
	sleep 0.2
	openrgb -c $(sed 's/#//' ~/.cache/wal/rgb.css) -b 35
	exit 0
else
	exit 1
fi
